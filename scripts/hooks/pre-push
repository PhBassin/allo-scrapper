#!/bin/sh
# pre-push hook: run tsc type-check and tests before every push
# To skip in an emergency: git push --no-verify

set -e

YELLOW='\033[0;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo "${YELLOW}[pre-push] Running TypeScript type-check...${NC}"
cd "$(git rev-parse --show-toplevel)/server"

if ! npx tsc --noEmit; then
  echo "${RED}[pre-push] TypeScript type-check FAILED. Push aborted.${NC}"
  echo "Fix the errors above, then push again."
  exit 1
fi

echo "${GREEN}[pre-push] Type-check passed.${NC}"

echo "${YELLOW}[pre-push] Running tests...${NC}"

if ! npm run test:run; then
  echo "${RED}[pre-push] Tests FAILED. Push aborted.${NC}"
  echo "Fix the failing tests above, then push again."
  exit 1
fi

echo "${GREEN}[pre-push] All checks passed. Pushing...${NC}"
exit 0
