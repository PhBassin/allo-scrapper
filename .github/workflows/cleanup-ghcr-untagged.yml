name: Nettoyage Images Untagged GHCR

on:
  schedule:
    - cron: '0 2 */5 * *' # 
  workflow_dispatch:     # Permet de le lancer manuellement pour tester

env:
  PACKAGE_NAME: allo-scrapper
  # Tags qui ne seront JAMAIS supprimÃ©s
  PROTECTED_TAGS: 'main,develop,stable,snapshot'

jobs:
  clean-ghcr:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # Obligatoire pour pouvoir supprimer des versions

    steps:
      - name: Supprimer les images sans tag protÃ©gÃ©
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const packageName = process.env.PACKAGE_NAME;
            const protectedTags = process.env.PROTECTED_TAGS.split(',').map(t => t.trim());
            const owner = context.repo.owner;

            console.log(`ðŸ” Package: ${packageName}`);
            console.log(`ðŸ›¡ï¸  Tags protÃ©gÃ©s: ${protectedTags.join(', ')}`);

            let page = 1;
            let scanned = 0;
            let deleted = 0;
            let kept = 0;
            const errors = [];

            while (true) {
              const { data: versions } = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                package_type: 'container',
                package_name: packageName,
                username: owner,
                per_page: 100,
                page,
              });

              if (versions.length === 0) break;

              for (const version of versions) {
                scanned++;
                const tags = version.metadata?.container?.tags ?? [];
                const hasProtectedTag = tags.some(tag => protectedTags.includes(tag));

                if (hasProtectedTag) {
                  console.log(`âœ… Conservation  [${version.id}] tags: ${tags.join(', ')}`);
                  kept++;
                  continue;
                }

                // Suppression : image sans tag protÃ©gÃ©
                // (non taggÃ©e, ou taggÃ©e avec sha256:..., hash commit, etc.)
                const label = tags.length ? tags.join(', ') : '(sans tag)';
                console.log(`ðŸ—‘ï¸  Suppression   [${version.id}] tags: ${label}`);

                try {
                  await github.rest.packages.deletePackageVersionForUser({
                    package_type: 'container',
                    package_name: packageName,
                    username: owner,
                    package_version_id: version.id,
                  });
                  deleted++;
                } catch (e) {
                  const msg = `Ã‰chec suppression version ${version.id} (${label}): ${e.message}`;
                  console.error(`âŒ ${msg}`);
                  errors.push(msg);
                }
              }

              page++;
            }

            // RÃ©sumÃ© dans le job summary
            await core.summary
              .addHeading('Nettoyage GHCR â€” RÃ©sumÃ©')
              .addTable([
                [{data: 'MÃ©trique', header: true}, {data: 'Valeur', header: true}],
                ['Versions scannÃ©es', String(scanned)],
                ['ConservÃ©es (tag protÃ©gÃ©)', String(kept)],
                ['SupprimÃ©es', String(deleted)],
                ['Erreurs', String(errors.length)],
              ])
              .addHeading('Politique de rÃ©tention', 3)
              .addRaw(`Tags protÃ©gÃ©s : \`${protectedTags.join('`, `')}\``)
              .addBreak()
              .addRaw('Toute image sans l\'un de ces tags est supprimÃ©e (non taggÃ©e, sha256, hash commitâ€¦)')
              .write();

            if (errors.length > 0) {
              core.setFailed(`${errors.length} erreur(s) lors du nettoyage.`);
            }
