name: GHCR Cleanup

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:

env:
  PACKAGE_NAME: allo-scrapper
  RETENTION_DAYS: 15

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Delete untagged and old images
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const packageName = process.env.PACKAGE_NAME;
            const retentionDays = Number(process.env.RETENTION_DAYS || '15');
            const cutoff = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);

            const ownerInfo = await github.rest.users.getByUsername({ username: owner });
            const scope = ownerInfo.data.type === 'Organization' ? 'orgs' : 'users';

            let page = 1;
            let scanned = 0;
            let deleted = 0;
            const versionsToDelete = [];

            while (true) {
              let versions;

              try {
                const response = await github.request(
                  `GET /${scope}/{owner}/packages/container/{package_name}/versions`,
                  {
                    owner,
                    package_name: packageName,
                    per_page: 100,
                    page,
                  }
                );
                versions = response.data;
              } catch (error) {
                if (error.status === 404) {
                  core.warning(`Package ${packageName} not found for owner ${owner}. Nothing to clean.`);
                  break;
                }
                throw error;
              }

              if (!versions.length) {
                break;
              }

              for (const version of versions) {
                scanned += 1;

                const tags = version.metadata?.container?.tags ?? [];
                const isUntagged = tags.length === 0;
                const isOlderThanRetention = new Date(version.updated_at) < cutoff;

                if (isUntagged || isOlderThanRetention) {
                  versionsToDelete.push({ id: version.id, tags });
                }
              }

              page += 1;
            }

            for (const version of versionsToDelete) {
              await github.request(
                `DELETE /${scope}/{owner}/packages/container/{package_name}/versions/{package_version_id}`,
                {
                  owner,
                  package_name: packageName,
                  package_version_id: version.id,
                }
              );

              deleted += 1;
              core.info(`Deleted version ${version.id} (tags: ${version.tags.join(', ') || 'none'})`);
            }

            core.summary
              .addHeading('GHCR cleanup summary')
              .addRaw(`Scanned versions: ${scanned}`)
              .addBreak()
              .addRaw(`Deleted versions: ${deleted}`)
              .addBreak()
              .addRaw(`Retention policy: untagged or older than ${retentionDays} days`)
              .write();
