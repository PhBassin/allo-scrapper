---
import Layout from '../layouts/Layout.astro';
import FilmCard from '../components/FilmCard.astro';
import { db } from '../db/client';
import { getWeeklyFilms, getCinemas } from '../db/queries';
import { getCurrentWeekStart } from '../utils/date';

const weekStart = getCurrentWeekStart();

const [films, cinemas] = await Promise.all([
  getWeeklyFilms(db, weekStart),
  getCinemas(db)
]);

// Formatter la date du mercredi
const weekDate = new Date(weekStart);
const weekEndDate = new Date(weekDate);
weekEndDate.setDate(weekDate.getDate() + 6);

const formatDate = (date: Date) => {
  return date.toLocaleDateString('fr-FR', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
};
const baseUrl = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
---

<Layout title="Accueil" description="Découvrez les films de la semaine dans nos cinémas partenaires">
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-4">Films de la semaine</h1>
    <p class="text-gray-600">
      Du {formatDate(weekDate)} au {formatDate(weekEndDate)}
    </p>
    
    <div class="mt-4 flex flex-wrap gap-3">
      {cinemas.map((cinema) => (
        <a 
          href={`${baseUrl}cinema/${cinema.id}`}
          class="px-4 py-2 bg-white border-2 border-gray-200 rounded-lg hover:border-primary hover:bg-yellow-50 transition font-medium"
        >
          {cinema.name}
        </a>
      ))}
    </div>
  </div>

  {films.length > 0 ? (
    <div class="space-y-6">
      {films.map((film) => (
        <div>
          <FilmCard film={film} />
          <div class="mt-2 ml-4 text-sm text-gray-600">
            <span class="font-semibold">Programmé dans:</span>
            {film.cinemas.map((cinema, idx) => (
              <span>
                {idx > 0 && ', '}
                <a href={`${baseUrl}cinema/${cinema.id}`} class="text-primary hover:underline">
                  {cinema.name}
                </a>
              </span>
            ))}
          </div>
        </div>
      ))}
    </div>
  ) : (
    <div class="card p-8 text-center">
      <p class="text-gray-600 text-lg">
        Aucun film programmé pour le moment. Lancez le scraper pour collecter les données :
      </p>
      <code class="block mt-4 bg-gray-100 p-4 rounded text-sm">
        npm run scrape
      </code>
    </div>
  )}
</Layout>
