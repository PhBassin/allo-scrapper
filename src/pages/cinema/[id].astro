---
import Layout from '../../layouts/Layout.astro';
import ShowtimeList from '../../components/ShowtimeList.astro';
import { getDatabase } from '../../db/schema';
import { getShowtimesByCinemaAndWeek, getCinemas } from '../../db/queries';
import { getCurrentWeekStart, getWeekDates, formatDate, getTodayDate } from '../../utils/date';
import type { Film, Showtime } from '../../scraper/types';

export async function getStaticPaths() {
  const db = getDatabase();
  try {
    const cinemas = getCinemas(db);
    return cinemas.map((cinema) => ({
      params: { id: cinema.id },
    }));
  } finally {
    db.close();
  }
}

const { id } = Astro.params;

// Initialiser les dates
const today = getTodayDate();
const currentWeekStart = getCurrentWeekStart();
const weekDates = getWeekDates(currentWeekStart);

const db = getDatabase();
let cinema;
let showtimesByDate = new Map<string, Array<{ film: Film; showtimes: Showtime[] }>>();

try {
  const cinemas = getCinemas(db);
  cinema = cinemas.find((c) => c.id === id);
  
  if (!cinema) {
    throw new Error(`Cinema ${id} not found`);
  }

  // R√©cup√©rer toutes les s√©ances de la semaine
  const allShowtimes = getShowtimesByCinemaAndWeek(db, id!, currentWeekStart);

  // Initialiser la Map pour chaque jour de la semaine (m√™me vide)
  weekDates.forEach(date => {
    showtimesByDate.set(date, []);
  });

  // Grouper les s√©ances par Date puis par Film
  const showtimesByDateAndFilm = new Map<string, Map<number, { film: Film; showtimes: Showtime[] }>>();

  allShowtimes.forEach((st) => {
    if (!showtimesByDateAndFilm.has(st.date)) {
      showtimesByDateAndFilm.set(st.date, new Map());
    }
    
    const dateMap = showtimesByDateAndFilm.get(st.date)!;
    
    if (!dateMap.has(st.film.id)) {
      dateMap.set(st.film.id, {
        film: st.film,
        showtimes: [],
      });
    }
    
    dateMap.get(st.film.id)!.showtimes.push(st);
  });

  // Convertir les Maps internes en Arrays et les stocker dans la Map principale
  showtimesByDateAndFilm.forEach((filmMap, date) => {
    if (showtimesByDate.has(date)) {
      showtimesByDate.set(date, Array.from(filmMap.values()));
    }
  });

} finally {
  db.close();
}

const baseUrl = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;

// Trouver l'index du jour actif par d√©faut (aujourd'hui ou le premier jour disponible)
const activeDateIndex = weekDates.indexOf(today) !== -1 ? weekDates.indexOf(today) : 0;
---

<Layout 
  title={cinema.name}
  description={`S√©ances de la semaine au cin√©ma ${cinema.name}`}
>
  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
      <a href={baseUrl} class="hover:text-primary hover:underline">‚Üê Accueil</a>
      <span>/</span>
      <span>{cinema.name}</span>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold mb-2">{cinema.name}</h1>
    
    {cinema.address && (
      <p class="text-gray-600 mb-1">üìç {cinema.address}, {cinema.postal_code} {cinema.city}</p>
    )}
    
    {cinema.screen_count && (
      <p class="text-gray-600">üé¨ {cinema.screen_count} salle{cinema.screen_count > 1 ? 's' : ''}</p>
    )}
  </div>

  <!-- S√©lecteur de jour -->
  <div class="mb-8 overflow-x-auto pb-2 -mx-4 px-4 md:mx-0 md:px-0">
    <div class="flex gap-2 min-w-max" role="tablist">
      {weekDates.map((date, index) => {
        const len = showtimesByDate.get(date)?.length;
        const hasShowtimes = (len ?? 0) > 0;
        
        
        
        return (
          <button
            class={`
              date-tab px-4 py-3 rounded-xl border-2 transition-all text-center min-w-[90px] group
              ${index === activeDateIndex 
                ? 'border-primary bg-yellow-50 text-black shadow-sm' 
                : 'border-transparent bg-white text-gray-600 hover:bg-gray-50'
              }
              ${!hasShowtimes && index !== activeDateIndex ? 'opacity-50' : ''}
            `}
            role="tab"
            aria-selected={index === activeDateIndex}
            aria-controls={`panel-${date}`}
            data-date={date}
          >
            <div class={`text-xs uppercase font-bold mb-0.5 ${index === activeDateIndex ? 'text-primary-dark' : 'text-gray-400 group-hover:text-gray-600'}`}>
              {new Date(date).toLocaleDateString('fr-FR', { weekday: 'short' }).replace('.', '')}
            </div>
            <div class="text-lg font-bold leading-none">
              {new Date(date).getDate()}
            </div>
            <div class="text-[10px] text-gray-400 mt-1">
              {new Date(date).toLocaleDateString('fr-FR', { month: 'short' })}
            </div>
          </button>
        );
      })}
    </div>
  </div>

  <!-- Contenu des onglets -->
  <div class="min-h-[300px]">
    {weekDates.map((date, index) => {
      const films = showtimesByDate.get(date) || [];
      const isActive = index === activeDateIndex;

      return (
        <div 
          id={`panel-${date}`}
          role="tabpanel"
          class={`date-panel space-y-6 ${isActive ? 'block' : 'hidden'}`}
        >
          {films.length > 0 ? (
            films.map(({ film, showtimes }) => (
              <div class="card p-5 md:p-6 transition hover:shadow-md border border-gray-100">
                <div class="flex flex-col md:flex-row gap-6">
                  {/* Poster (Mobile: hidden, Desktop: visible) */}
                  {film.poster_url && (
                    <div class="hidden md:block w-24 flex-shrink-0">
                      <img 
                        src={film.poster_url} 
                        alt={film.title} 
                        class="w-full rounded shadow-sm"
                        loading="lazy"
                      />
                    </div>
                  )}

                  <div class="flex-grow">
                    <div class="mb-4">
                      <h2 class="text-xl md:text-2xl font-bold mb-1">
                        <a href={`/film/${film.id}`} class="hover:text-primary transition">
                          {film.title}
                        </a>
                      </h2>
                      
                      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-gray-600 mb-3">
                        {film.duration_minutes && (
                          <span>
                            ‚è± {Math.floor(film.duration_minutes / 60)}h{film.duration_minutes % 60 > 0 ? `${film.duration_minutes % 60}`.padStart(2, '0') : ''}
                          </span>
                        )}
                        {film.genres && film.genres.length > 0 && (
                          <span class="px-1.5 py-0.5 bg-gray-100 rounded text-xs">
                            {film.genres[0]}
                          </span>
                        )}
                        {film.director && (
                          <span class="hidden sm:inline">de {film.director}</span>
                        )}
                      </div>

                      {/* Ratings */}
                      {(film.press_rating || film.audience_rating) && (
                        <div class="flex gap-3 mb-4">
                          {film.press_rating && (
                            <div class="flex items-center gap-1">
                              <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded">Presse</span>
                              <span class="font-bold text-sm">‚òÖ {film.press_rating.toFixed(1)}</span>
                            </div>
                          )}
                          {film.audience_rating && (
                            <div class="flex items-center gap-1">
                              <span class="text-xs font-bold bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded">Spectateurs</span>
                              <span class="font-bold text-sm">‚òÖ {film.audience_rating.toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    <div class="pt-2 border-t border-gray-100">
                      <ShowtimeList showtimes={showtimes} />
                    </div>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
              <p class="text-gray-500 font-medium">Aucune s√©ance programm√©e ce jour-l√†</p>
              <p class="text-sm text-gray-400 mt-1">Essayez un autre jour de la semaine</p>
            </div>
          )}
        </div>
      );
    })}
  </div>
</Layout>

<script>
  // Script simple pour g√©rer les onglets sans rechargement
  const tabs = document.querySelectorAll('.date-tab');
  const panels = document.querySelectorAll('.date-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetDate = tab.getAttribute('data-date');

      // Update tabs
      tabs.forEach(t => {
        const isSelected = t === tab;
        t.setAttribute('aria-selected', isSelected ? 'true' : 'false');
        
        if (isSelected) {
          t.classList.add('border-primary', 'bg-yellow-50', 'text-black', 'shadow-sm');
          t.classList.remove('border-transparent', 'bg-white', 'text-gray-600');
          t.querySelector('.text-xs').classList.add('text-primary-dark');
          t.querySelector('.text-xs').classList.remove('text-gray-400');
        } else {
          t.classList.remove('border-primary', 'bg-yellow-50', 'text-black', 'shadow-sm');
          t.classList.add('border-transparent', 'bg-white', 'text-gray-600');
          t.querySelector('.text-xs').classList.remove('text-primary-dark');
          t.querySelector('.text-xs').classList.add('text-gray-400');
        }
      });

      // Update panels
      panels.forEach(panel => {
        if (panel.id === `panel-${targetDate}`) {
          panel.classList.remove('hidden');
          panel.classList.add('block');
        } else {
          panel.classList.add('hidden');
          panel.classList.remove('block');
        }
      });
    });
  });
</script>
